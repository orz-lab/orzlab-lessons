<div id="controls"
    style="margin: 15px 0; display: flex; flex-wrap: wrap; gap: 20px; align-items: center; font-family: sans-serif;">
    <div>
        <label for="wind-direction">Hướng Gió (0°-360°):</label>
        <input type="range" id="wind-direction" min="0" max="360" value="45">
        <span id="direction-value">45°</span>
    </div>
    <div>
        <label for="wind-speed">Tốc Độ Gió (0-100) km/h:</label>
        <input type="range" id="wind-speed" min="0" max="100" value="50">
        <span id="speed-value">50</span>
    </div>
</div>

<div id="wind-canvas-container" style="border: 1px solid #ccc;"></div>

<script>
    function windSketch(p) {

        // Các biến điều khiển
        let directionSlider, speedSlider;
        let directionValueSpan, speedValueSpan;

        // Các đối tượng trong mô phỏng
        let windArrow;
        let particles = [];
        const NUM_PARTICLES = 100;

        p.setup = function () {
            let container = p.select('#wind-canvas-container');
            let canvasWidth = container ? container.width : 600;
            let canvas = p.createCanvas(canvasWidth, 400);
            canvas.parent(container);
            p.angleMode(p.DEGREES);

            directionSlider = p.select('#wind-direction');
            speedSlider = p.select('#wind-speed');
            directionValueSpan = p.select('#direction-value');
            speedValueSpan = p.select('#speed-value');

            windArrow = new WindArrow(p.width / 2, p.height / 2);

            for (let i = 0; i < NUM_PARTICLES; i++) {
                particles.push(new Particle());
            }
        };

        p.draw = function () {
            p.background(245, 245, 245);

            let direction = directionSlider.value();
            let speed = speedSlider.value();

            directionValueSpan.html(direction + '°');
            speedValueSpan.html(speed);

            let vectorLength = speed * 1.5;
            windArrow.update(direction, vectorLength);
            windArrow.display();

            let windForce = p5.Vector.fromAngle(p.radians(direction), speed / 100);

            // **THAY ĐỔI QUAN TRỌNG:**
            // Truyền giá trị 'speed' vào hàm update của mỗi hạt
            particles.forEach(particle => {
                particle.applyForce(windForce);
                particle.update(speed); // <--- Truyền tốc độ vào đây
                particle.edges();
                particle.display();
            });
        };

        // Class cho Vector Gió (Không đổi)
        class WindArrow {
            constructor(x, y) { this.pos = p.createVector(x, y); }
            update(angle, magnitude) { this.angle = angle; this.magnitude = magnitude; }
            display() {
                p.push();
                p.translate(this.pos.x, this.pos.y);
                p.rotate(this.angle);
                p.strokeWeight(3);
                p.stroke(40, 120, 200);
                p.fill(40, 120, 200);
                p.line(0, 0, this.magnitude, 0);
                p.translate(this.magnitude, 0);
                p.triangle(0, 0, -12, -6, -12, 6);
                p.pop();
            }
        }

        // Class cho các hạt bụi
        class Particle {
            constructor() {
                this.pos = p.createVector(p.random(p.width), p.random(p.height));
                this.vel = p.createVector(0, 0);
                this.acc = p.createVector(0, 0);
                // **THAY ĐỔI QUAN TRỌNG:**
                // Xóa bỏ this.maxSpeed cố định
            }

            applyForce(force) {
                this.acc.add(force);
            }

            // **THAY ĐỔI QUAN TRỌNG:**
            // Hàm update giờ nhận vào tốc độ gió
            update(windSpeed) {
                this.vel.add(this.acc);

                // Giới hạn tốc độ của hạt tỉ lệ với tốc độ gió
                // Hệ số 0.05 để tốc độ không quá nhanh trên màn hình
                let maxSpeed = windSpeed * 0.05;
                this.vel.limit(maxSpeed);

                this.pos.add(this.vel);
                this.acc.mult(0);
            }

            edges() {
                if (this.pos.x > p.width) this.pos.x = 0;
                if (this.pos.x < 0) this.pos.x = p.width;
                if (this.pos.y > p.height) this.pos.y = 0;
                if (this.pos.y < 0) this.pos.y = p.height;
            }

            display() {
                p.stroke(150);
                p.strokeWeight(4);
                p.point(this.pos.x, this.pos.y);
            }
        }
    }

    new p5(windSketch);
</script>